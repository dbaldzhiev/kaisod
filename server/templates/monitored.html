{% extends "base.html" %}
{% block content %}
<section class="monitored">
  <h2>Monitored items</h2>
  <div class="monitored-actions">
    <div class="sync-controls">
      <button type="button" id="sync-missing-button" {% if missing_count == 0 %}disabled{% endif %}>
        Sync missing monitored items
      </button>
      <p class="help-text" id="missing-sync-help">
        {{ missing_count }} item{{ '' if missing_count == 1 else 's' }} {{ 'is' if missing_count == 1 else 'are' }} missing locally.
      </p>
    </div>
    <div id="missing-sync-progress" class="sync-progress" data-total="{{ missing_count }}">
      <div class="sync-progress-bar"><span class="sync-progress-fill"></span></div>
      <p class="sync-progress-message" data-role="message">No sync in progress.</p>
      <p class="sync-progress-detail" data-role="detail"></p>
    </div>
  </div>
  <p class="storage-note">
    Files are stored under <code>{{ storage_root }}</code>, mirroring the KAIS folder hierarchy. Each row shows whether the
    latest archive is present locally.
  </p>
  {% if items %}
    <table class="monitored-table">
      <thead>
        <tr>
          <th scope="col">Title</th>
          <th scope="col">Section</th>
          <th scope="col">Last change (KAIS)</th>
          <th scope="col">Sync status</th>
          <th scope="col">Last download</th>
          <th scope="col">Local folder</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for item in items %}
          <tr>
            <td data-label="Title">
              <a href="{{ url_for('item_history', item_id=item.id) }}">{{ item.title }}</a>
            </td>
            <td data-label="Section">{{ item.path or '—' }}</td>
            <td data-label="Last change">{{ item.last_seen_date | format_datetime }}</td>
            <td data-label="Sync status" class="sync-status">
              <span class="node-sync sync-{{ item.sync_state }}">{{ item.sync_label }}</span>
            </td>
            <td data-label="Last download">{{ item.last_downloaded_at | format_datetime }}</td>
            <td data-label="Local folder" class="local-folder">
              <code title="Latest extracted files">{{ storage_root }}/{{ item.latest_extract_relative }}</code>
              {% if not item.latest_extract_exists %}
                <span class="local-missing">missing</span>
              {% endif %}
            </td>
            <td data-label="Actions" class="actions">
              {% if item.file_url %}
                <a href="{{ item.file_url }}" target="_blank" rel="noopener">Download</a>
              {% else %}
                —
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>No items are currently monitored.</p>
  {% endif %}
</section>
{% endblock %}
