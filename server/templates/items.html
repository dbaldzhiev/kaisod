{% extends "base.html" %}
{% macro render_node(node) %}
  <li
    class="tree-node {{ node.node_type }}"
    data-path="{{ node.path }}"
    {% if node.node_type == 'file' %}data-item-id="{{ node.item.id }}"{% endif %}
  >
    <div class="tree-row">
      <div class="tree-info">
        <span class="node-name">{{ node.name }}</span>
        {% if node.node_type == 'directory' %}
          <span class="node-count">{{ node.total }} items</span>
        {% else %}
          <span class="node-date">{{ node.item.last_seen_date | format_datetime }}</span>
          <span class="node-status {{ node.item.status }}">{{ node.item.status }}</span>
        {% endif %}
      </div>
      <div class="tree-controls">
        <div class="toggle-group">
          {% set monitor_checked = node.monitor_state == 'all' %}
          <label class="toggle">
            <input
              type="checkbox"
              class="monitor-toggle"
              data-state="{{ node.monitor_state }}"
              {% if node.node_type == 'directory' %}data-section-path="{{ node.path }}"{% else %}data-item-id="{{ node.item.id }}"{% endif %}
              {% if monitor_checked %}checked{% endif %}
            />
            <span></span>
          </label>
          {% set ignore_checked = node.ignore_state == 'all' %}
          <label class="toggle">
            <input
              type="checkbox"
              class="ignore-toggle"
              data-state="{{ node.ignore_state }}"
              {% if node.node_type == 'directory' %}data-section-path="{{ node.path }}"{% else %}data-item-id="{{ node.item.id }}"{% endif %}
              {% if ignore_checked %}checked{% endif %}
            />
            <span></span>
          </label>
        </div>
        {% if node.node_type == 'file' %}
          <div class="tree-links">
            <a href="{{ url_for('item_history', item_id=node.item.id) }}">History</a>
            {% if node.item.file_url %}
              <a href="{{ node.item.file_url }}" target="_blank" rel="noopener">Download</a>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
    {% if node.children %}
      <ul class="tree-children">
        {% for child in node.sorted_children() %}
          {{ render_node(child) }}
        {% endfor %}
      </ul>
    {% endif %}
  </li>
{% endmacro %}

{% block content %}
<section class="filters">
  <form method="get">
    <label>
      Status
      <select name="status">
        <option value="">All</option>
        <option value="new" {% if status_filter == 'new' %}selected{% endif %}>New</option>
        <option value="updated" {% if status_filter == 'updated' %}selected{% endif %}>Updated</option>
        <option value="seen" {% if status_filter == 'seen' %}selected{% endif %}>Seen</option>
      </select>
    </label>
    <label>
      Monitored
      <select name="monitored">
        <option value="">All</option>
        <option value="1" {% if monitored_filter == '1' %}selected{% endif %}>Yes</option>
        <option value="0" {% if monitored_filter == '0' %}selected{% endif %}>No</option>
      </select>
    </label>
    <button type="submit">Apply</button>
  </form>
</section>

<section class="items-tree">
  <h2>Open data tree</h2>
  {% if tree.children %}
    <ul class="tree-root">
      {% for child in tree.sorted_children() %}
        {{ render_node(child) }}
      {% endfor %}
    </ul>
  {% else %}
    <p>No items recorded yet.</p>
  {% endif %}
</section>
{% endblock %}
