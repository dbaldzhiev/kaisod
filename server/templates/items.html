{% extends "base.html" %}
{% macro render_node(node) %}
  <li
    class="tree-node {{ node.node_type }}"
    data-path="{{ node.path }}"
    {% if node.node_type == 'directory' %}
      data-monitored-count="{{ node.monitored }}"
      data-unsynced-count="{{ node.unsynced }}"
    {% else %}
      data-item-id="{{ node.item.id }}"
      data-sync-state="{{ node.item.sync_state }}"
    {% endif %}
  >
    <div class="tree-row">
      <div class="tree-collapse">
        {% if node.node_type == 'directory' %}
          <button
            type="button"
            class="collapse-toggle"
            aria-expanded="true"
            aria-label="Collapse section"
            title="Collapse section"
          >▾</button>
        {% else %}
          <span class="collapse-spacer"></span>
        {% endif %}
      </div>
      <div class="tree-info">
        <span class="node-name">{{ node.name }}</span>
        {% if node.node_type == 'directory' %}
          <span class="node-count">
            {{ node.total }} items
            {% if node.monitored %}
              · {{ node.monitored }} monitored
            {% endif %}
            {% if node.unsynced %}
              · <span class="node-unsynced">{{ node.unsynced }} need sync</span>
            {% endif %}
          </span>
        {% else %}
          <span class="node-date">{{ node.item.last_seen_date | format_datetime }}</span>
          <span class="node-status {{ node.item.status }}">{{ node.item.status }}</span>
          <span class="node-sync sync-{{ node.item.sync_state }}">{{ node.item.sync_label }}</span>
          {% if node.item.last_downloaded_at %}
            <span class="node-download">Downloaded {{ node.item.last_downloaded_at | format_datetime }}</span>
          {% endif %}
          <span class="node-local" title="Latest extracted files: {{ node.item.latest_extract_path }}">
            Latest folder: <code>{{ node.item.latest_extract_path }}</code>
            {% if not node.item.latest_extract_exists %}
              <span class="local-missing">missing</span>
            {% endif %}
          </span>
        {% endif %}
      </div>
      <div class="tree-controls">
        <div class="toggle-group">
          {% set monitor_checked = node.monitor_state == 'all' %}
          <label class="toggle">
            <input
              type="checkbox"
              class="monitor-toggle"
              data-state="{{ node.monitor_state }}"
              {% if node.node_type == 'directory' %}data-section-path="{{ node.path }}"{% else %}data-item-id="{{ node.item.id }}"{% endif %}
              {% if monitor_checked %}checked{% endif %}
            />
            <span></span>
          </label>
        </div>
        {% if node.node_type == 'file' %}
          <div class="tree-links">
            <a href="{{ url_for('item_history', item_id=node.item.id) }}">History</a>
            {% if node.item.file_url %}
              <a href="{{ node.item.file_url }}" target="_blank" rel="noopener">Download</a>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
    {% if node.children %}
      <ul class="tree-children">
        {% for child in node.sorted_children() %}
          {{ render_node(child) }}
        {% endfor %}
      </ul>
    {% endif %}
  </li>
{% endmacro %}

{% block content %}
<section class="filters">
  <form method="get">
    <label>
      Status
      <select name="status">
        <option value="">All</option>
        <option value="new" {% if status_filter == 'new' %}selected{% endif %}>New</option>
        <option value="updated" {% if status_filter == 'updated' %}selected{% endif %}>Updated</option>
        <option value="seen" {% if status_filter == 'seen' %}selected{% endif %}>Seen</option>
      </select>
    </label>
    <label>
      Monitored
      <select name="monitored">
        <option value="">All</option>
        <option value="1" {% if monitored_filter == '1' %}selected{% endif %}>Yes</option>
        <option value="0" {% if monitored_filter == '0' %}selected{% endif %}>No</option>
      </select>
    </label>
    <button type="submit">Apply</button>
  </form>
</section>

<section class="storage-info">
  <h2>Storage layout</h2>
  <p>
    Downloads are saved under <code>{{ storage_root }}</code>.
    Each item uses <code>{{ storage_root }}/&lt;item-id&gt;/</code> with the current extraction in
    <code>latest/</code> and dated archives kept separately.
  </p>
</section>

<section class="items-tree">
  <h2>Open data tree</h2>
  <div class="tree-toolbar">
    <div class="tree-tools">
      <button type="button" id="expand-all">Expand all</button>
      <button type="button" id="collapse-all">Collapse all</button>
      <button type="button" id="expand-monitored">Expand monitored</button>
      <button type="button" id="expand-unsynced">Expand needing sync</button>
      <button type="button" id="reset-tree-state" class="link-button">Reset view</button>
    </div>
    <div class="tree-legend">
      <span><span class="legend-pill sync-synced"></span> Up to date</span>
      <span><span class="legend-pill sync-outdated"></span> Needs sync</span>
      <span><span class="legend-pill sync-missing"></span> Not downloaded</span>
    </div>
  </div>
  {% if tree.children %}
    <ul class="tree-root">
      {% for child in tree.sorted_children() %}
        {{ render_node(child) }}
      {% endfor %}
    </ul>
  {% else %}
    <p>No items recorded yet.</p>
  {% endif %}
</section>
{% endblock %}
